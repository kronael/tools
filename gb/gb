#!/bin/bash

dedupe(){ awk '!seen[$0]++'; }
strip_origin(){ sed 's|^origin/||'; }

recent(){
    git reflog --format='%gs' --all \
        | grep -oP 'checkout: moving from .* to \K.*' \
        | dedupe \
        | head -50
}

all(){
    git for-each-ref --sort=-committerdate \
        --format='%(refname:short)' refs/heads refs/remotes
}

[[ "$1" == "-u" ]] && { fetch=1; shift; }

branch=$({ recent; all; } \
    | strip_origin \
    | dedupe \
    | fzf --height=40% --select-1 --exit-0 --query="$1")

[[ -n "$branch" ]] && {
    [[ $fetch ]] && git fetch
    git checkout "origin/$branch"
}
