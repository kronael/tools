#!/bin/bash
# dockbox - spawn dockerized claude code with isolated permissions
# Usage: dockbox [options] [dirs...] [-- command...]

set -euo pipefail

IMAGE="dockbox"
# Set after dirs parsed

# Claude config mounts (rw needed for debug, todos, statsig, etc.)
CLAUDE_MOUNTS=(
    "$HOME/.claude:/home/claude/.claude:rw"
    "$HOME/.claude.json:/tmp/host-claude.json:ro"
    "$HOME/.dockbox_history:/home/claude/.zsh_history:rw"
)

# Other read-only mounts
READONLY_MOUNTS=(
    "/etc/localtime:/etc/localtime:ro"
)

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
    cat <<EOF
Usage: dockbox [-n name] [dirs...] [-- command...]

Options:
    -n name    Override container name (default: dockbox-<project>)

Examples:
    dockbox                           # current dir, runs claude
    dockbox ~/wk/project              # mount project, runs claude
    dockbox ~/wk/p1 ~/wk/p2           # mount multiple dirs
    dockbox -n mybox .                # custom container name
    dockbox . -- bash                 # run bash instead
    dockbox . -- claude --help        # pass args to claude

Mounts (automatic):
    ~/.claude            -> /home/claude/.claude (rw)
    ~/.claude.json       -> copied at startup (ephemeral)
    ~/.dockbox_history   -> /home/claude/.zsh_history (rw)

Project dirs are mounted at exact paths with read-write.
Default command: claude

Configuration (~/.dockboxrc and .dockboxrc in project dir):
    Extra docker args, one per line. # comments, blank lines ok.
    Global rc applies first, project rc appends.
EOF
    exit 0
fi

# Parse flags, dirs, and command
name_override=""
dirs=()
cmd=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        -n) name_override="$2"; shift 2 ;;
        --) shift; cmd=("$@"); break ;;
        *)  dirs+=("$1"); shift ;;
    esac
done

# Default to current directory
[[ ${#dirs[@]} -eq 0 ]] && dirs=(.)

# Default command is claude
[[ ${#cmd[@]} -eq 0 ]] && cmd=(claude)

mounts=()
workdir=""

# Ensure history file exists
[[ -f "$HOME/.dockbox_history" ]] || touch "$HOME/.dockbox_history"

# Add Claude config mounts
for m in "${CLAUDE_MOUNTS[@]}"; do
    src="${m%%:*}"
    [[ -e "$src" ]] && mounts+=(-v "$m")
done

# Add read-only mounts
for m in "${READONLY_MOUNTS[@]}"; do
    src="${m%%:*}"
    [[ -e "$src" ]] && mounts+=(-v "$m")
done

# Add project directories as read-write at exact same paths
for dir in "${dirs[@]}"; do
    dir="$(cd "$dir" && pwd)"
    mounts+=(-v "$dir:$dir:rw")
    workdir="$dir"
done

# Container name from project dir or override
CONTAINER_NAME="${name_override:-dockbox-${workdir##*/}}"

# Load .dockboxrc files (global then project)
rcargs=()
for rc in "$HOME/.dockboxrc" "$workdir/.dockboxrc"; do
    [[ -f "$rc" ]] || continue
    while IFS= read -r line; do
        [[ -z "$line" || "$line" == \#* ]] && continue
        rcargs+=("$line")
    done < "$rc"
done

# Overmount project .dockboxrc so container can't modify it
[[ -f "$workdir/.dockboxrc" ]] && \
    mounts+=(-v "/dev/null:$workdir/.dockboxrc:ro")

# Check for existing container
existing=$(docker ps -q -f "name=^${CONTAINER_NAME}$" 2>/dev/null)
if [[ -n "$existing" ]]; then
    echo "container '$CONTAINER_NAME' is already running" >&2
    echo "use -n <name> to pick a different name, or stop it first" >&2
    exit 1
fi
docker rm -f "$CONTAINER_NAME" 2>/dev/null || true

exec docker run -it --rm \
    --name "$CONTAINER_NAME" \
    -e HOME=/home/claude \
    "${mounts[@]}" \
    "${rcargs[@]}" \
    -w "$workdir" \
    -- "$IMAGE" \
    "${cmd[@]}"
