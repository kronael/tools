#!/bin/bash
set -euo pipefail

IMAGE="dockbox"

MOUNTS=(
    "$HOME/.claude:/home/claude/.claude:rw"
    "$HOME/.claude.json:/tmp/host-claude.json:ro"
    "$HOME/.gitconfig:/home/claude/.gitconfig:ro"
    "$HOME/.gnupg:/home/claude/.gnupg:ro"
    "$HOME/.dockbox_history:/home/claude/.zsh_history:rw"
    "/etc/localtime:/etc/localtime:ro"
)

if [[ "${1:-}" == "ls" ]]; then
    docker container ls -a --filter "name=^dockbox-" \
        --format "table {{.Names}}\t{{.Status}}\t{{.RunningFor}}"
    exit 0
fi

if [[ "${1:-}" == "rm" ]]; then
    pattern="${2:-}"
    names=$(docker container ls -a --filter "name=^dockbox-" \
        --format "{{.Names}}")
    [[ -z "$names" ]] && { echo "no dockbox containers"; exit 0; }
    if [[ -n "$pattern" ]]; then
        names=$(echo "$names" | grep -F "$pattern" || true)
        [[ -z "$names" ]] && { echo "no match for '$pattern'"; exit 0; }
    fi
    echo "$names" | while read -r n; do
        docker rm -f "$n" && echo "removed $n"
    done
    exit 0
fi

if [[ "${1:-}" == "prune" ]]; then
    hours="${2:-2160}"
    cutoff=$(date -d "-${hours} hours" +%s 2>/dev/null) || \
        cutoff=$(date -v-${hours}H +%s)
    docker container ls -a --filter "name=^dockbox-" --filter "status=exited" \
        --format "{{.Names}}\t{{.CreatedAt}}" | while IFS=$'\t' read -r name created; do
        ts=$(date -d "$created" +%s 2>/dev/null) || \
            ts=$(date -j -f "%Y-%m-%d %H:%M:%S %z" "$created" +%s)
        if [[ "$ts" -lt "$cutoff" ]]; then
            docker rm "$name" && echo "removed $name"
        fi
    done
    exit 0
fi

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
    cat <<EOF
Usage: dockbox [options] [dirs...] [claude-args...]
       dockbox ls
       dockbox rm [pattern]
       dockbox prune [hours]

Options:
    -n name    Override container name (default: dockbox-<project>)
    -e cmd     Override entrypoint (default: claude)

Examples:
    dockbox                           # current dir, runs claude
    dockbox ~/wk/project              # mount project
    dockbox ~/wk/p1 ~/wk/p2           # mount multiple dirs
    dockbox -n mybox .                 # custom container name
    dockbox -c                        # continue last session
    dockbox -e bash                   # run bash instead

Mounts (automatic):
    ~/.claude            -> /home/claude/.claude (rw)
    ~/.claude.json       -> copied at startup (ephemeral)
    ~/.gitconfig         -> /home/claude/.gitconfig (ro)
    ~/.dockbox_history   -> /home/claude/.zsh_history (rw)

Project dirs are mounted at exact paths with read-write.
Default command: claude

Configuration (~/.dockboxrc and .dockboxrc in project dir):
    Extra docker args, one per line. # comments, blank lines ok.
    Global rc applies first, project rc appends.
EOF
    exit 0
fi

name_override=""
entrypoint="claude"
dirs=()
claude_args=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        -n) name_override="${2:?-n requires a name}"; shift 2 ;;
        -e) entrypoint="${2:?-e requires a command}"; shift 2 ;;
        /*)  dirs+=("$1"); shift ;;
        .*)  dirs+=("$1"); shift ;;
        ~*)  dirs+=("$1"); shift ;;
        *)   claude_args+=("$1"); shift ;;
    esac
done

[[ ${#dirs[@]} -eq 0 ]] && dirs=(.)
cmd=("$entrypoint" "${claude_args[@]}")

mounts=()
workdir=""

[[ -f "$HOME/.dockbox_history" ]] || touch "$HOME/.dockbox_history"

for m in "${MOUNTS[@]}"; do
    src="${m%%:*}"
    [[ -e "$src" ]] && mounts+=(-v "$m")
done

for dir in "${dirs[@]}"; do
    dir="$(cd "$dir" && pwd)"
    mounts+=(-v "$dir:$dir:rw")
    workdir="$dir"
done

CONTAINER_NAME="${name_override:-dockbox-${workdir##*/}}"

rcargs=()
for rc in "$HOME/.dockboxrc" "$workdir/.dockboxrc"; do
    [[ -f "$rc" ]] || continue
    while IFS= read -r line; do
        [[ -z "$line" || "$line" == \#* ]] && continue
        rcargs+=("$line")
    done < "$rc"
done

# overmount so container can't modify project .dockboxrc
[[ -f "$workdir/.dockboxrc" ]] && \
    mounts+=(-v "/dev/null:$workdir/.dockboxrc:ro")

existing=$(docker ps -q -f "name=^${CONTAINER_NAME}$" 2>/dev/null)
if [[ -n "$existing" ]]; then
    echo "container '$CONTAINER_NAME' is already running" >&2
    echo "use -n <name> or stop it first" >&2
    exit 1
fi
docker rm -f "$CONTAINER_NAME" 2>/dev/null || true

exec docker run -it --rm \
    --name "$CONTAINER_NAME" \
    -e HOME=/home/claude \
    "${mounts[@]}" \
    "${rcargs[@]}" \
    -w "$workdir" \
    -- "$IMAGE" \
    "${cmd[@]}"
