#!/bin/bash

# ── Shared helpers ──────────────────────────────────────────────────

dedupe(){ awk '!seen[$0]++'; }
strip_origin(){ sed 's|^origin/||'; }

recent(){
    git reflog --format='%gs' --all \
        | grep -oP 'checkout: moving from .* to \K.*' \
        | dedupe \
        | head -50
}

all(){
    git for-each-ref --sort=-committerdate \
        --format='%(refname:short)' refs/heads refs/remotes
}

branches(){ { recent; all; } | strip_origin | dedupe; }

clean_branch(){
    echo "$1" | sed -E 's#^(origin/|refs/|heads/|remotes/)+##'
}

get_current_branch(){
    local head=HEAD
    while :; do
        local this=$(git name-rev --name-only $head 2>/dev/null)
        [[ "$this" != "undefined" && -n "$this" ]] && break
        head+=^
    done
    clean_branch "$this"
}

is_commit_not_branch(){
    git rev-parse --verify "$1^{commit}" &>/dev/null \
        && ! git show-ref --verify --quiet "refs/heads/$1" \
        && ! git show-ref --verify --quiet "refs/remotes/origin/$1"
}

pick_branch(){
    if [[ "$1" == "?" ]]; then
        branches | fzf --height=40%
    else
        branches | fzf --height=40% --select-1 --exit-0 \
            --query="$1"
    fi
}

# ── Subcommands ─────────────────────────────────────────────────────

BRANCH_HELP="Usage: rig %s [-z] [-n] [pattern]
Flags: -z offline (no fetch), -n dry-run, ? force fzf"

cmd_branch_op(){
    local op=$1; shift

    # Parse flags
    local fetch=1
    while [[ "${1:-}" =~ ^- ]]; do
        case "$1" in
            -z|--offline) fetch=; shift ;;
            -n) local dryrun=1; shift ;;
            -h|--help) printf "$BRANCH_HELP\n" "$op"; exit 0 ;;
            *) echo "error: unknown flag: $1"; exit 1 ;;
        esac
    done

    # Select branch
    local branch=$(pick_branch "$1")
    [[ -z "$branch" ]] && {
        echo "error: no branch selected"; exit 1
    }

    # Execute
    if [[ ${dryrun:-} ]]; then
        echo "origin/$branch"
    else
        [[ $fetch ]] && git fetch
        case "$op" in
            checkout) git checkout "origin/$branch" ;;
            rebase)   git rebase -i "origin/$branch" ;;
            merge)    git merge "origin/$branch" ;;
        esac
    fi
}

cmd_push(){
    # Parse flags
    while [[ "${1:-}" =~ ^- ]]; do
        case "$1" in
            -n) local dryrun=1; shift ;;
            -h|--help)
                cat <<EOF
Usage: rig push [-n] [branch[:commit]] [git-push-flags]
Flags: -n dry-run, ? interactive selection
EOF
                exit 0 ;;
            *) break ;;
        esac
    done

    # Select branch and commit
    local branch commit="HEAD"
    case "${1:-}" in
        "")  branch=$(get_current_branch) ;;
        "?") branch=$(pick_branch "?")
             [[ -z "$branch" ]] && exit 1; shift ;;
        *:*) branch=$(clean_branch "${1%:*}")
             commit=${1#*:}; shift ;;
        *)   if is_commit_not_branch "$1"; then
                 echo "warn: '$1' looks like a commit, not a branch"
                 echo "      use branch:commit syntax"
                 branch=$(get_current_branch)
             else
                 branch=$(clean_branch "$1")
             fi; shift ;;
    esac

    # Validate
    [[ -z "$branch" || "$branch" == "undefined" ]] && {
        echo "error: could not determine branch"
        echo "usage: rig push [branch] or rig push ?"
        exit 1
    }

    # Execute
    if [[ ${dryrun:-} ]]; then
        echo "git push origin $@ $commit:refs/heads/$branch"
    else
        git push origin "$@" "$commit:refs/heads/$branch"
    fi
}

# ── Install ──────────────────────────────────────────────────────────

cmd_install(){
    local dir=$(dirname "$(readlink -f "$0")")
    local symlinks=(rio rip rir rim)
    for s in "${symlinks[@]}"; do
        ln -sf rig "$dir/$s"
        echo "  $dir/$s -> rig"
    done
    echo "installed ${#symlinks[@]} symlinks"
}

# ── Dispatch ────────────────────────────────────────────────────────

usage(){
    cat <<EOF
rig - ripgit: git tools

  rig co [pattern]   Checkout origin (rio)
  rig p [branch]     Push to origin (rip)
  rig r [pattern]    Rebase -i origin (rir)
  rig m [pattern]    Merge origin (rim)
  rig install        Create symlinks

Flags: -z offline, -n dry-run, ? force fzf
EOF
    exit 1
}

dispatch(){
    case "$1" in
        co|checkout|rio) shift; cmd_branch_op checkout "$@" ;;
        p|push|rip)      shift; cmd_push "$@" ;;
        r|rebase|rir)    shift; cmd_branch_op rebase "$@" ;;
        m|merge|rim)     shift; cmd_branch_op merge "$@" ;;
        install)         cmd_install ;;
        -h|--help|help|"") usage ;;
        *)  echo "error: unknown command: $1"; usage ;;
    esac
}

# Busybox-style: detect invocation name, then subcommand
name=$(basename "$0")
[[ "$name" != "rig" ]] && dispatch "$name" "$@" || dispatch "${1:-}" "$@"
